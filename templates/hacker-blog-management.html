{% extends "base_user.html" %}
{% block title %}Blog Management{% endblock title %}

{% block content %}
<!-- MAIN ------------------------------------------------------------ -->
<main class="container my-5">

    <a href="{% url 'dashboard' %}" class="text-cyan back-link">
        <i class="bi bi-arrow-left"></i> Back to Dashboard
    </a>

    <h1 class="page-title">Blog Management</h1>
    <p class="page-subtitle">Share your cybersecurity knowledge through blogs.</p>

    <!-- Create Blog -->
    <div class="create-blog-section">
        <button class="button-primary" data-bs-toggle="modal" data-bs-target="#createBlogModal">
            <i class="bi bi-plus-circle me-2"></i>Create New Blog
        </button>
    </div>

    <ul class="nav nav-tabs blog-tabs mt-4">
        <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" href="#published">Published</a>
        </li>
    </ul>

    <div class="tab-content mt-3">

        <!-- Dynamic Blog List -->
        <div class="tab-pane fade show active" id="published">
            <div class="row">

                {% if blogs %}
                    {% for blog in blogs %}
                    <div class="col-md-6 mb-4">
                        <div class="card-dark blog-card">

                            <div class="blog-card-header">
                                <h4 class="blog-card-title">{{ blog.title }}</h4>
                                <span class="badge badge-resolved">Published</span>
                            </div>

                            <p class="blog-card-excerpt">
                                {{ blog.content|truncatechars:120 }}
                            </p>

                            <div class="blog-card-footer">
                                <div class="blog-card-meta">
                                    <i class="bi bi-calendar3 me-1"></i> 
                                    {{ blog.created_on|date:"M d, Y" }}

                                    <span class="blog-card-meta-item">
                                        <i class="bi bi-eye me-1"></i> {{ blog.views }} views
                                    </span>
                                </div>

                                <div class="blog-card-actions">
                                    <button 
                                        class="blog-action-btn blog-action-edit" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#editBlogModal"
                                        data-id="{{ blog.id }}"
                                        data-title="{{ blog.title }}"
                                        data-category="{{ blog.category }}"
                                        data-content="{{ blog.content }}"
                                        data-image="{% if blog.featured_image %}{{ blog.featured_image.url }}{% endif %}"
                                    >
                                        <i class="bi bi-pencil"></i> Edit
                                    </button>


                                    <form method="POST" action="{% url 'delete_blog' blog.id %}" style="display:inline;">
                                        {% csrf_token %}
                                        <button class="blog-action-btn blog-action-delete">
                                            <i class="bi bi-trash"></i> Delete
                                        </button>
                                    </form>
                                </div>
                            </div>

                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-gray text-center mt-4">No blogs published yet.</p>
                {% endif %}

            </div>
        </div>

    </div>

</main>

<!-- Create Blog Modal ------------------------------------------------>
<div class="modal fade" id="createBlogModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content modal-dark">

            <div class="modal-header modal-header-dark">
                <h5 class="modal-title modal-title-dark">Create New Blog</h5>
                <button type="button" class="btn-close modal-close-light" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <form id="blogForm" method="POST" enctype="multipart/form-data">
                    {% csrf_token %}

                    <div class="form-group">
                        <label class="form-label">Blog Title *</label>
                        <input type="text" name="title" maxlength="50" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Category *</label>
                        <input type="text" name="category" maxlength="20" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Content *</label>
                        <textarea name="content" class="form-input" rows="8" required></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Featured Image</label>
                        <input type="file" name="featured_image" accept="image/*" class="form-input">
                    </div>

                </form>

            </div>

            <div class="modal-footer modal-footer-dark">
                <button type="button" class="button-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="blogForm" class="button-primary">Publish Blog</button>
            </div>

        </div>
    </div>
</div>
<!-- Edit Blog Modal -->
<div class="modal fade" id="editBlogModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content modal-dark">

            <div class="modal-header modal-header-dark">
                <h5 class="modal-title modal-title-dark">Edit Blog</h5>
                <button type="button" class="btn-close modal-close-light" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <form id="editBlogForm" method="POST" enctype="multipart/form-data">
                    {% csrf_token %}

                    <input type="hidden" name="blog_id" id="editBlogId">

                    <div class="form-group">
                        <label class="form-label">Blog Title *</label>
                        <input type="text" name="title" id="editTitle" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Category *</label>
                        <input type="text" name="category" id="editCategory" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Content *</label>
                        <textarea name="content" id="editContent" class="form-input" rows="8" required></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Featured Image</label>
                        <input type="file" name="featured_image" class="form-input">
                        <img id="editImagePreview" src="" class="mt-3" width="180">
                    </div>

                </form>

            </div>

            <div class="modal-footer modal-footer-dark">
                <button type="button" class="button-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="editBlogForm" class="button-primary">Update Blog</button>
            </div>

        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {

    const editModal = document.getElementById("editBlogModal");

    editModal.addEventListener("show.bs.modal", function (event) {
        const button = event.relatedTarget;

        document.getElementById("editBlogId").value = button.dataset.id;
        document.getElementById("editTitle").value = button.dataset.title;
        document.getElementById("editCategory").value = button.dataset.category;
        document.getElementById("editContent").value = button.dataset.content;

        const img = button.dataset.image;
        if (img) {
            document.getElementById("editImagePreview").src = img;
        } else {
            document.getElementById("editImagePreview").src = "";
        }

        // Change form action dynamically
        document.getElementById("editBlogForm").action = `/blog_mgmt/edit/${button.dataset.id}/`;
    });

});
</script>
{% endblock content %}