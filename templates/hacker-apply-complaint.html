{% extends "base_user.html" %}
{% block title %}Apply To Complaints{% endblock title %}

{% block content %}

<!-- MAIN -->
<main class="container my-5">

    <a href="hacker-dashboard.html" class="back-link">
        <i class="bi bi-arrow-left"></i> Back to Dashboard
    </a>

    <h1 class="page-title">Browse & Apply to Complaints</h1>
    <p class="page-subtitle">Find complaints that match your skills and apply to work on them.</p>

    <div class="row">

        {% for c in complaints %}
        <div class="col-md-6 mb-4">
            <div class="card-dark p-4" style="height:100%; position:relative;">

                {% if c.date_submitted|timesince < "1 day" %}
                <span class="badge badge-pending" style="position:absolute; top:16px; right:16px; font-size:11px;">NEW</span>
                {% endif %}

                <div style="margin-bottom:16px;">
                    <h4 style="font-size:18px; color:#00D9FF; margin-bottom:8px;">{{ c.title }}</h4>
                    <span style="color:#6B7280; font-size:13px;">Complaint ID: #{{ c.id }}</span>
                </div>

                <div style="margin-bottom:16px;">
                    <span class="badge badge-info" style="font-size:11px;">{{ c.category|title }}</span>
                    <span class="badge"
                          style="background:rgba(245,158,11,0.1); color:#F59E0B; border:1px solid #F59E0B; font-size:11px; margin-left:6px;">
                        {% if c.service_type == "COMPLETE" %}Complete Solution
                        {% elif c.service_type == "GUIDE" %}Report + Guide
                        {% else %}Report Only{% endif %}
                    </span>
                </div>

                <p style="color:#9CA3AF; font-size:14px; line-height:1.6; margin-bottom:16px;">
                    {{ c.description|truncatechars:160 }}
                </p>

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px; padding:12px; background:#1A1F2E; border-radius:8px;">
                    <div>
                        <div style="color:#6B7280; font-size:12px;">Budget</div>
                        <div style="color:#00D9FF; font-weight:600; font-size:15px;">
                            {% if c.service_type == "COMPLETE" %}â‚¹250kâ€“â‚¹40k
                            {% elif c.service_type == "GUIDE" %}â‚¹15kâ€“â‚¹20k
                            {% else %}â‚¹10kâ€“â‚¹12k{% endif %}
                        </div>
                    </div>
                    <div>
                        <div style="color:#6B7280; font-size:12px;">Posted</div>
                        <div style="color:#F9FAFB; font-size:14px;">{{ c.date_submitted|timesince }} ago</div>
                    </div>
                    <div>
                        <div style="color:#6B7280; font-size:12px;">Priority</div>
                        <div style="color:#F59E0B; font-weight:600; font-size:14px;">{{ c.priority }}</div>
                    </div>
                    <div>
                        <div style="color:#6B7280; font-size:12px;">Applications</div>
                        <div style="color:#F9FAFB; font-size:14px;">{{ c.applications_set.count }} applied</div>
                    </div>
                </div>

                <div style="display:flex; gap:12px;">
                    <button type="button" class="button-primary" style="flex:1;"
                            onclick="openApplyModal('{{ c.id }}', '{{ c.title }}')">
                        <i class="bi bi-send me-1"></i> Apply Now
                    </button>
                </div>

            </div>
        </div>
        {% endfor %}

    </div>
</main>

<!-- APPLY MODAL -->
<div class="modal fade" id="applyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content modal-dark">
            <div class="modal-header modal-header-dark">
                <h5 class="modal-title modal-title-dark" id="modalTitle"></h5>
                <button type="button" class="btn-close modal-close-light" data-bs-dismiss="modal"></button>
            </div>

            <form id="applyForm" method="POST">
                {% csrf_token %}
                <div class="modal-body">

                    <input type="hidden" name="complaint_id" id="complaintId">

                    <div class="form-group">
                        <label class="form-label">Your Proposal *</label>
                        <textarea name="proposal" class="form-input" rows="5" required></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Estimated Completion Time *</label>
                        <select name="estimated_time" class="form-input" required>
                            <option value="">Select timeframe</option>
                            <option value="1-2 days">1â€“2 days</option>
                            <option value="3-5 days">3â€“5 days</option>
                            <option value="1 week">1 week</option>
                            <option value="2 weeks">2 weeks</option>
                        </select>
                    </div>

                </div>

                <div class="modal-footer modal-footer-dark">
                    <button type="button" class="button-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="button-primary">Submit Application</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- REQUIRED JS (THIS WAS MISSING) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
function openApplyModal(id, title) {
    document.getElementById("complaintId").value = id;
    document.getElementById("modalTitle").innerText = "Apply to: " + title;

    // ðŸ”‘ THIS IS THE URL THAT MAKES APPLY WORK
    document.getElementById("applyForm").action = "/apply-to-complaint/" + id + "/";

    new bootstrap.Modal(document.getElementById('applyModal')).show();
}
</script>
{% endblock content %}
<!-- FOOTER (UNCHANGED) -->
