<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Awareness Session - Cyber Bridge</title>

    <!-- Bootstrap & Icons -->
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
        rel="stylesheet"
    >
    <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.min.css"
    >

    <!-- Custom Styles -->
    <link rel="stylesheet" href="{% static "css/styles.css" %}">
</head>
<body>
    <!-- ================= NAVBAR ================= -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm py-3 fixed-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="index.html">
                <img src="{% static "images/CB.png" %}" alt="Cyber Bridge Logo" style="height:50px; margin-right:10px;">
                <span style="color:#00D9FF; font-weight:700;">Cyber Bridge</span>
            </a>

            <button
                class="navbar-toggler"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#navbarNav"
                aria-controls="navbarNav"
                aria-expanded="false"
                aria-label="Toggle navigation"
            >
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                <ul class="navbar-nav align-items-center">
                    <li class="nav-item">
                        <a class="nav-link active" href="business-dashboard.html">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="complaint-detail.html">Complaints</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="book-session.html">Bookings</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Payments</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="business-profile.html">Profile</a>
                    </li>
                    <li class="nav-item ms-3">
                        <div class="navbar-user">
                            <div class="notification-icon">
                                <i class="bi bi-bell"></i>
                                <span class="notification-badge">0</span>
                            </div>
                            <div class="dropdown">
                                <a
                                    class="nav-link dropdown-toggle"
                                    href="#"
                                    role="button"
                                    data-bs-toggle="dropdown"
                                >
                                    <i class="bi bi-person-circle"></i> User
                                </a>
                                <ul
                                    class="dropdown-menu dropdown-menu-end"
                                    style="background-color: #1a1f29; border: 1px solid #1f2937;"
                                >
                                    <li>
                                        <a class="dropdown-item" href="business-profile.html" style="color: #e5e7eb;">
                                            Profile
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="index.html" style="color: #EF4444;">
                                            Logout
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- ================= MAIN CONTENT (CENTERED FORM) ================= -->
    <main class="booking-page">
        <div class="container">
            <div class="card-dark p-4 booking-container">

                <!-- Progress Bar -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between mb-2">
                        <div><span id="stepLabel1" class="step-label step-active">1. Organization</span></div>
                        <div><span id="stepLabel2" class="step-label">2. Session</span></div>
                        <div><span id="stepLabel3" class="step-label">3. Confirm</span></div>
                    </div>
                    <div class="progress wizard-progress">
                        <div id="progressBar" class="progress-bar wizard-progress-bar"></div>
                    </div>
                </div>

                <!-- FORM -->
                <form id="awarenessForm" method="POST">
                    {% csrf_token %}

                    <!-- Hidden fields for backend ------>
                    <input type="hidden" name="package_price" id="hiddenPackagePrice">
                    <input type="hidden" name="extra_price" id="hiddenExtraPrice">
                    <input type="hidden" name="total_price" id="hiddenTotalPrice">

                    <!-- STEP 1: ORGANIZATION DETAILS -->
                    <div id="step1" class="wizard-step active">
                        <h3 class="wizard-title"><i class="bi bi-building me-2"></i>Organization Details</h3>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Company Name *</label>
                                <input type="text" class="form-input" name="companyName" value="{{ pending.company_name|default:business.company_name }}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Contact Person *</label>
                                <input type="text" class="form-input" name="contactPerson" value=" {{pending.contact_person|default:''}} "required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Contact Number * (+91)</label>
                                <input type="tel" value="{{ pending.phone|default:'' }}" class="form-input" name="phone" pattern="[0-9]{10}" placeholder="10-digit number" maxlength="10" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Email *</label>
                                <input type="email" class="form-input" name="email" value="{{pending.email|default:business.user.email }}" required>
                            </div>
                        </div>

                        <button type="button" class="button-primary mt-3" onclick="nextStep(1)">Next</button>
                    </div>

                    <!-- STEP 2 -->
                    <div id="step2" class="wizard-step">
                        <h3 class="wizard-title"><i class="bi bi-calendar-check me-2"></i>Session Preferences</h3>

                        <!-- Mode -->
                        <div class="mb-4">
                            <label class="form-label mb-3 d-block">Session Mode *</label>
                            <div class="d-flex gap-3 flex-wrap">
                                <label class="radio-option">
                                    <input type="radio" name="sessionMode" value="online" {% if pending.session_mode == "online" %}checked{% endif %} required onchange="togglePackages()">
                                    <span class="radio-check"></span> Online
                                </label>

                                <label class="radio-option">
                                    <input type="radio" name="sessionMode" value="offline" {% if pending.session_mode == "offline" %}checked{% endif %} required onchange="togglePackages()">
                                    <span class="radio-check"></span> Offline
                                </label>
                            </div>
                        </div>

                        <!-- Online Packages -->
                        <div id="onlinePackages" class="packages-section" style="display: none;">
                            <label class="form-label mb-3">Select Package *</label>
                            <div class="d-flex flex-wrap gap-2 mb-4">
                                <label class="package-card">
                                    <input type="radio" name="package" value="basic-online" data-price="6000" {% if pending.package == "basic-online" %}checked{% endif %} onchange="updatePricing()">
                                    <div class="package-card-content">
                                        <div class="package-card-name">BASIC</div>
                                        <strong class="package-card-price">₹6,000</strong>
                                        <small class="package-card-details">2 hours, Zoom</small>
                                    </div>
                                </label>

                                <label class="package-card">
                                    <input type="radio" name="package" value="standard-online" data-price="10000" {% if pending.package == "standard-online" %}checked{% endif %} onchange="updatePricing()">
                                    <div class="package-card-content">
                                        <div class="package-card-name">STANDARD</div>
                                        <strong class="package-card-price">₹10,000</strong>
                                        <small class="package-card-details">4 hours, Zoom + Recording</small>
                                    </div>
                                </label>

                                <label class="package-card">
                                    <input type="radio" name="package" value="premium-online" data-price="13000" {% if pending.package == "premium-online" %}checked{% endif %} onchange="updatePricing()">
                                    <div class="package-card-content">
                                        <div class="package-card-name">PREMIUM</div>
                                        <strong class="package-card-price">₹13,000</strong>
                                        <small class="package-card-details">5+ hours, Zoom + Q&amp;A</small>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Offline Packages -->
                        <div id="offlinePackages" class="packages-section" style="display: none;">
                            <label class="form-label mb-3">Select Package *</label>
                            <div class="d-flex flex-wrap gap-2 mb-4">
                                <label class="package-card">
                                    <input type="radio" name="package" value="basic-offline" data-price="9000" {% if pending.package == "basic-offline" %}checked{% endif %} onchange="updatePricing()">
                                    <div class="package-card-content">
                                        <div class="package-card-name">BASIC</div>
                                        <strong class="package-card-price">₹9,000</strong>
                                        <small class="package-card-details">2 hours, On-site</small>
                                    </div>
                                </label>

                                <label class="package-card">
                                    <input type="radio" name="package" value="standard-offline" data-price="15000" {% if pending.package == "standard-offline" %}checked{% endif %} onchange="updatePricing()">
                                    <div class="package-card-content">
                                        <div class="package-card-name">STANDARD</div>
                                        <strong class="package-card-price">₹15,000</strong>
                                        <small class="package-card-details">4 hours, On-site</small>
                                    </div>
                                </label>

                                <label class="package-card">
                                    <input type="radio" name="package" value="premium-offline" data-price="20000" {% if pending.package == "premium-offline" %}checked{% endif %} onchange="updatePricing()">
                                    <div class="package-card-content">
                                        <div class="package-card-name">PREMIUM</div>
                                        <strong class="package-card-price">₹20,000</strong>
                                        <small class="package-card-details">5+ hours, On-site</small>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Date & Location -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Preferred Date *</label>
                                <input type="date" class="form-input" name="preferredDate" id="preferredDate" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Location <span id="locationRequired">(Offline only)</span></label>
                                <textarea class="form-input" name="location" rows="2" id="locationField">{{ pending.location|default:business.address }}</textarea>
                            </div>
                        </div>

                        <div class="d-flex gap-3 mt-3">
                            <button type="button" class="button-secondary" onclick="prevStep(2)">Back</button>
                            <button type="button" class="button-primary" onclick="nextStep(2)">Next</button>
                        </div>
                    </div>

                    <!-- STEP 3 -->
                    <div id="step3" class="wizard-step">
                        <h3 class="wizard-title"><i class="bi bi-check-circle me-2"></i>Confirm &amp; Book</h3>

                        <div class="mb-4">
                            <label class="form-label mb-2">Number of Participants *</label>
                            <input type="number" id="participantsInput" min="1" max="500" value="{{ pending.participants|default:50 }}" class="form-input participant-input" name="participants" oninput="updatePricing()" required>
                            <small class="form-hint">Maximum: 500</small>
                        </div>

                        <!-- Pricing Summary -->
                        <div class="pricing-preview card-dark p-4 mb-4">
                            <h4 class="pricing-title">Pricing Summary</h4>

                            <div class="row text-center mb-3">
                                <div class="col-6">
                                    <div id="packagePreview" class="pricing-label">Select Package</div>
                                    <div id="packagePrice" class="pricing-package-amount">₹0</div>
                                </div>
                                <div class="col-6">
                                    <div id="extraPreview" class="pricing-label">Extra Participants</div>
                                    <div id="extraPrice" class="pricing-extra-amount">₹0</div>
                                </div>
                            </div>

                            <hr class="pricing-divider">

                            <div class="d-flex justify-content-between align-items-center">
                                <span class="pricing-total-label">TOTAL AMOUNT</span>
                                <span id="totalPrice" class="pricing-total-amount">₹0</span>
                            </div>
                        </div>

                        <div class="d-flex gap-3 mt-4">
                            <button type="button" class="button-secondary" onclick="prevStep(3)">Back</button>
                            <button type="submit" class="button-primary booking-submit-btn">Book Session</button>
                        </div>
                    </div>
                </form>

            </div>
        </div>
    </main>

    <!-- SCRIPTS -->
   <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.getElementById('preferredDate').min = new Date().toISOString().split('T')[0];

        function nextStep(current) {
            const currentStep = document.getElementById('step' + current);
            // Select all required inputs, including radio buttons within package sections
            const inputs = currentStep.querySelectorAll('input:required, textarea:required, select:required');
            let valid = true;

            inputs.forEach(input => {
                if (!input.checkValidity()) {
                    valid = false;
                    input.reportValidity();
                }
            });

            // Extra validation for step 2 (mode + package)
            if (current === 2) {
                const mode = document.querySelector('input[name="sessionMode"]:checked');
                const pkg = document.querySelector('input[name="package"]:checked');
                
                // Ensure location is required for offline mode
                const locationField = document.getElementById('locationField');
                if (mode && mode.value === 'offline' && locationField.value.trim() === '') {
                    alert('Please enter the location for an offline session.');
                    valid = false;
                }

                if (!mode || !pkg) {
                    if(valid) alert('Please select session mode and package'); // Only alert if other validation passed
                    valid = false;
                }
            }
            // Extra validation for step 3 (participants)
            if (current === 3) {
                const participantsInput = document.getElementById('participantsInput');
                if (participantsInput.value < 1 || participantsInput.value > 500) {
                    alert('Number of participants must be between 1 and 500.');
                    participantsInput.reportValidity();
                    valid = false;
                }
            }

            if (valid) {
                document.getElementById('step' + current).classList.remove('active');
                document.getElementById('step' + (current + 1)).classList.add('active');

                // Update progress bar
                const progress = ((current + 1) / 3) * 100;
                document.getElementById('progressBar').style.width = progress + '%';

                // Update step labels
                for (let i = 1; i <= 3; i++) {
                    const label = document.getElementById('stepLabel' + i);
                    if (i <= current + 1) {
                        label.classList.add('step-active');
                    } else {
                        label.classList.remove('step-active');
                    }
                }

                // When entering step 3, refresh pricing
                if (current + 1 === 3) {
                    updatePricing();
                }
            }
        }

        function prevStep(current) {
            document.getElementById('step' + current).classList.remove('active');
            document.getElementById('step' + (current - 1)).classList.add('active');

            const progress = ((current - 1) / 3) * 100;
            document.getElementById('progressBar').style.width = progress + '%';

            // Update step labels
            for (let i = 1; i <= 3; i++) {
                const label = document.getElementById('stepLabel' + i);
                if (i < current) {
                    label.classList.add('step-active');
                } else {
                    label.classList.remove('step-active');
                }
            }
        }

        // -------- TOGGLE PACKAGE VISIBILITY --------
        function togglePackages() {
            const mode = document.querySelector('input[name="sessionMode"]:checked');
            const onlinePackages = document.getElementById('onlinePackages');
            const offlinePackages = document.getElementById('offlinePackages');
            const locationField = document.getElementById('locationField');
            const locationRequired = document.getElementById('locationRequired');

            // Clear previous package selection
            document.querySelectorAll('input[name="package"]').forEach(input => {
                input.checked = false;
            });

            if (!mode) return;

            if (mode.value === 'online') {
                onlinePackages.style.display = 'block';
                offlinePackages.style.display = 'none';

                locationField.removeAttribute('required');
                locationRequired.textContent = '(Optional)';
                locationRequired.style.color = '#9CA3AF'; // Assuming this is the desired color
            } else {
                onlinePackages.style.display = 'none';
                offlinePackages.style.display = 'block';

                locationField.setAttribute('required', 'required');
                locationRequired.innerHTML = '<span style="color: #EF4444;">*</span>'; // Required color
            }

            // Reset pricing summary when mode changes
            updatePricing();
        } // <-- CORRECTED: Closing brace for togglePackages()
    

        // ---------- PRICING with hidden input update ----------
        function updatePricing() {
            const participantsInput = document.getElementById('participantsInput');
            
            // Check if element exists before accessing its value
            if (!participantsInput) return;

            let participants = parseInt(participantsInput.value) || 1;
            // Clamp participants value
            participants = Math.max(1, Math.min(500, participants));
            participantsInput.value = participants; // Update the input field with the clamped value

            const packageInput = document.querySelector('input[name="package"]:checked');
            if (!packageInput) {
                document.getElementById('packagePreview').textContent = 'Select Package';
                document.getElementById('packagePrice').textContent = '₹0';
                document.getElementById('extraPreview').textContent = 'Extra Participants';
                document.getElementById('extraPrice').textContent = '₹0';
                document.getElementById('totalPrice').textContent = '₹0';
                // Also reset hidden fields
                document.getElementById("hiddenPackagePrice").value = 0;
                document.getElementById("hiddenExtraPrice").value = 0;
                document.getElementById("hiddenTotalPrice").value = 0;
                return;
            }

            const packagePrice = parseInt(packageInput.dataset.price);
            // First 50 participants are included in the package price.
            let extraParticipants = participants > 50 ? participants - 50 : 0;
            let extraCost = extraParticipants * 500; // ₹500 per extra participant

            const total = packagePrice + extraCost;

            // Update Pricing Summary Display
            const packageDisplayName = packageInput.value.split('-')[0].toUpperCase() + ' Package';
            document.getElementById('packagePreview').textContent = packageDisplayName;
            document.getElementById('packagePrice').textContent = `₹${packagePrice.toLocaleString('en-IN')}`;
            document.getElementById('extraPreview').textContent = `Extra Participants (${extraParticipants} x ₹500)`;
            document.getElementById('extraPrice').textContent = `₹${extraCost.toLocaleString('en-IN')}`;
            document.getElementById('totalPrice').textContent = `₹${total.toLocaleString('en-IN')}`;

            // SAVE TO HIDDEN FIELDS (FOR FORM SUBMISSION)
            document.getElementById("hiddenPackagePrice").value = packagePrice;
            document.getElementById("hiddenExtraPrice").value = extraCost;
            document.getElementById("hiddenTotalPrice").value = total;
        }

        // Call updatePricing on page load to initialize hidden fields if a package is pre-selected,
        // and to set up the default pricing summary.
        // In this case, since nothing is pre-selected, it will reset the summary.
        window.onload = function() {
            updatePricing();
        };
    </script>
<script>
window.onload = function () {
    updatePricing();

    {% if pending %}
        // Auto show correct package section
        const mode = "{{ pending.session_mode }}";
        if (mode) {
            document.querySelector(`input[name="sessionMode"][value="${mode}"]`)?.click();
        }

        // Recalculate pricing after restore
        setTimeout(() => {
            updatePricing();

            // Jump to confirm step
            document.getElementById("step1").classList.remove("active");
            document.getElementById("step2").classList.remove("active");
            document.getElementById("step3").classList.add("active");

            document.getElementById("progressBar").style.width = "100%";
            document.getElementById("stepLabel1").classList.add("step-active");
            document.getElementById("stepLabel2").classList.add("step-active");
            document.getElementById("stepLabel3").classList.add("step-active");
        }, 200);
    {% endif %}
};
</script>

</body>
</html>